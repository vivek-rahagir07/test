<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>BMU Campus Radio</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Three.js (background) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <!-- Import map -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
      }
    }
  </script>

  <style>
    :root {
      --bg-dark: #020617;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-bg: rgba(15, 23, 42, 0.7);
    }

    body {
      background-color: var(--bg-dark);
      color: #f8fafc;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid var(--glass-border);
    }

    .glass-card {
      background: linear-gradient(
        145deg,
        rgba(30, 41, 59, 0.4),
        rgba(15, 23, 42, 0.6)
      );
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease,
        border-color 0.2s ease;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -2px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.1);
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .animate-slide-up {
      animation: slideUp 0.45s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.98);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .animate-fade-in {
      animation: fadeIn 0.35s ease-out forwards;
    }

    @keyframes pop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.4);
      }
      100% {
        transform: scale(1);
      }
    }
    .animate-pop {
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .equalizer-bar {
      animation: equalizer 1s infinite ease-in-out;
    }
    @keyframes equalizer {
      0% {
        height: 3px;
      }
      50% {
        height: 12px;
      }
      100% {
        height: 3px;
      }
    }

    @keyframes toast-in {
      from {
        transform: translateY(-20px) translateX(-50%);
        opacity: 0;
      }
      to {
        transform: translateY(0) translateX(-50%);
        opacity: 1;
      }
    }
    .animate-toast {
      animation: toast-in 0.3s ease-out forwards;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from "react";
    import { createRoot } from "react-dom/client";
    import {
      Play,
      Pause,
      Music,
      User,
      Plus,
      Heart,
      MessageCircle,
      Radio,
      Ghost,
      LogOut,
      X,
      Share2,
      Search,
      Trash2,
      Home,
      Calendar,
      Send,
      BellRing,
      CheckCircle,
      MoreVertical,
      Phone,
      UserCircle,
      Briefcase,
      GraduationCap,
      Lock,
      Mail,
      Camera,
      AlertCircle,
      Upload,
      Mic,
      Video
    } from "lucide-react";

    import { initializeApp } from "firebase/app";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      updateProfile,
      signOut
    } from "firebase/auth";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      query,
      orderBy,
      doc,
      updateDoc,
      deleteDoc,
      increment,
      where
    } from "firebase/firestore";
    import {
      getStorage,
      ref,
      uploadBytesResumable,
      getDownloadURL
    } from "firebase/storage";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA5qQbhXqej2Ill5jtHWgvsBpk9BsR3a7c",
      authDomain: "bmuradio.firebaseapp.com",
      databaseURL: "https://bmuradio-default-rtdb.firebaseio.com",
      projectId: "bmuradio",
      storageBucket: "bmuradio.firebasestorage.app",
      messagingSenderId: "230545998240",
      appId: "1:230545998240:web:c1832311a2f066cb7b24c5",
      measurementId: "G-51N1VLP1DY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Mock posts
    const MOCK_POSTS = [
      {
        id: "mock1",
        title: "Welcome to BMU Radio!",
        description: "This is a demo broadcast. Log in to post your own!",
        authorName: "Admin_Staff",
        category: "buzz",
        broadcastType: "live",
        createdAt: { seconds: Date.now() / 1000 },
        likes: 42,
        mediaUrl: ""
      },
      {
        id: "mock2",
        title: "Campus Jazz Vibes",
        description: "Smooth jazz for studying in the library.",
        authorName: "JazzClub_Student",
        category: "music",
        broadcastType: "recorded",
        createdAt: { seconds: Date.now() / 1000 - 3600 },
        likes: 12,
        mediaUrl: ""
      }
    ];

    const SCHEDULE_DATA = [
      {
        id: 4,
        title: "Student Council Updates",
        host: "Pres. Office",
        time: "04:00 PM",
        type: "News",
        live: false
      },
      {
        id: 5,
        title: "Late Night Confessions",
        host: "Anonymous",
        time: "10:00 PM",
        type: "Buzz",
        live: false
      }
    ];

    // Toast
    const Toast = ({ message, onClose }) => {
      useEffect(() => {
        const t = setTimeout(onClose, 3000);
        return () => clearTimeout(t);
      }, [onClose]);
      return (
        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[100] animate-toast">
          <div className="bg-slate-900/90 text-white px-5 py-3 rounded-full border border-emerald-400/40 shadow-xl flex items-center gap-2">
            <CheckCircle size={16} className="text-emerald-400" />
            <span className="text-sm font-medium">{message}</span>
          </div>
        </div>
      );
    };

    // Simple particle background
    const Background3D = () => {
      const mountRef = useRef(null);
      useEffect(() => {
        if (typeof THREE === "undefined") return;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 0, 8);

        const renderer = new THREE.WebGLRenderer({
          alpha: true,
          antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        mountRef.current.appendChild(renderer.domElement);

        const particles = new THREE.BufferGeometry();
        const count = 400;
        const pos = new Float32Array(count * 3);
        for (let i = 0; i < count * 3; i++) {
          pos[i] = (Math.random() - 0.5) * 20;
        }
        particles.setAttribute("position", new THREE.BufferAttribute(pos, 3));
        const mat = new THREE.PointsMaterial({
          size: 0.03,
          transparent: true,
          opacity: 0.7
        });
        const mesh = new THREE.Points(particles, mat);
        scene.add(mesh);

        const animate = () => {
          requestAnimationFrame(animate);
          const t = Date.now() * 0.0003;
          mesh.rotation.y = t;
          mesh.rotation.x = t / 2;
          renderer.render(scene, camera);
        };
        animate();

        const onResize = () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        };
        window.addEventListener("resize", onResize);

        return () => {
          window.removeEventListener("resize", onResize);
          mountRef.current.removeChild(renderer.domElement);
          renderer.dispose();
        };
      }, []);
      return <div ref={mountRef} className="fixed inset-0 -z-10" />;
    };

    // LOGIN PAGE (Student / Staff + guest)
    const LoginSelection = ({ onLogin, error }) => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [role, setRole] = useState("student");
      const [isSignUp, setIsSignUp] = useState(false);
      const [localError, setLocalError] = useState(null);
      const [loading, setLoading] = useState(false);
      const [profileImage, setProfileImage] = useState(null);
      const fileRef = useRef(null);

      const handleImageChange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        if (f.size > 600000) {
          setLocalError("Profile image max 600KB");
          return;
        }
        const reader = new FileReader();
        reader.onloadend = () => setProfileImage(reader.result);
        reader.readAsDataURL(f);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLocalError(null);
        if (!email.endsWith("@bmu.edu.in")) {
          setLocalError("Use your college ID (@bmu.edu.in)");
          return;
        }
        setLoading(true);
        try {
          if (isSignUp) {
            const cred = await createUserWithEmailAndPassword(
              auth,
              email,
              password
            );
            const name = email.split("@")[0];
            const displayName =
              name.charAt(0).toUpperCase() + name.slice(1) + "_" + role;
            await updateProfile(cred.user, {
              displayName,
              photoURL: profileImage
            });
            onLogin(cred.user, role);
          } else {
            const cred = await signInWithEmailAndPassword(auth, email, password);
            const detected =
              cred.user.displayName?.includes("_staff") ? "staff" : "student";
            onLogin(cred.user, detected);
          }
        } catch (err) {
          setLocalError(err.message.replace("Firebase:", "").trim());
        } finally {
          setLoading(false);
        }
      };

      const guestLogin = () => {
        onLogin(
          {
            uid: "guest",
            displayName: "Guest_User",
            photoURL: null,
            isAnonymous: true
          },
          "guest"
        );
      };

      return (
        <div className="min-h-screen flex items-center justify-center px-4 relative">
          <Background3D />
          <div className="w-full max-w-md bg-white/95 rounded-3xl shadow-2xl border border-slate-200 p-7 relative z-10 animate-slide-up">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shadow-lg">
                <Radio size={22} />
              </div>
              <div>
                <h1 className="text-xl font-black text-slate-900 tracking-tight">
                  BMU Campus Radio
                </h1>
                <p className="text-xs text-slate-500">
                  Studio access for BMU community
                </p>
              </div>
            </div>

            {(localError || error) && (
              <div className="bg-red-50 border border-red-200 text-red-700 text-xs rounded-xl px-3 py-2 mb-3 flex gap-2">
                <AlertCircle size={14} className="mt-0.5" />
                <span>{localError || error}</span>
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-4">
              {isSignUp && (
                <div className="flex flex-col items-center mb-1">
                  <input
                    type="file"
                    accept="image/*"
                    className="hidden"
                    ref={fileRef}
                    onChange={handleImageChange}
                  />
                  <button
                    type="button"
                    onClick={() => fileRef.current.click()}
                    className="w-20 h-20 rounded-full border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:border-indigo-500 hover:text-indigo-500 transition-colors overflow-hidden bg-slate-50"
                  >
                    {profileImage ? (
                      <img
                        src={profileImage}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <Camera size={20} />
                    )}
                  </button>
                  <span className="text-[11px] text-slate-500 mt-1">
                    Upload profile photo
                  </span>
                </div>
              )}

              <div className="flex bg-slate-100 rounded-xl p-1 text-xs font-semibold">
                {["student", "staff"].map((r) => (
                  <button
                    key={r}
                    type="button"
                    onClick={() => setRole(r)}
                    className={`flex-1 flex items-center justify-center gap-1 py-2 rounded-lg transition ${
                      role === r
                        ? "bg-slate-900 text-white"
                        : "text-slate-500"
                    }`}
                  >
                    {r === "student" ? (
                      <GraduationCap size={14} />
                    ) : (
                      <Briefcase size={14} />
                    )}
                    <span>{r === "student" ? "Student" : "Staff"}</span>
                  </button>
                ))}
              </div>

              <div className="space-y-3">
                <div className="relative">
                  <Mail
                    size={16}
                    className="absolute left-3 top-3 text-slate-400"
                  />
                  <input
                    type="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="college_id@bmu.edu.in"
                    className="w-full border border-slate-200 rounded-xl pl-9 pr-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/80 focus:border-slate-900"
                  />
                </div>
                <div className="relative">
                  <Lock
                    size={16}
                    className="absolute left-3 top-3 text-slate-400"
                  />
                  <input
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Password"
                    className="w-full border border-slate-200 rounded-xl pl-9 pr-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/80 focus:border-slate-900"
                  />
                </div>
              </div>

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-slate-900 text-white rounded-xl py-2.5 text-sm font-semibold flex items-center justify-center gap-2 hover:bg-black transition disabled:opacity-60"
              >
                {loading ? (
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                ) : isSignUp ? (
                  "Create Studio Profile"
                ) : (
                  "Enter Studio"
                )}
              </button>
            </form>

            <div className="mt-4 flex items-center justify-between text-[11px]">
              <button
                onClick={() => setIsSignUp((v) => !v)}
                className="text-slate-600 hover:text-slate-900 underline underline-offset-4"
              >
                {isSignUp
                  ? "Already on BMU Radio? Login"
                  : "New to BMU Radio? Create account"}
              </button>
              <button
                onClick={guestLogin}
                className="text-slate-400 hover:text-slate-700"
              >
                Continue as guest
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Schedule
    const ScheduleView = ({ showToast }) => (
      <div className="p-5 pb-24 animate-fade-in" key="schedule">
        <div className="mb-6 animate-slide-up">
          <h2 className="text-2xl font-black text-white">Broadcast Schedule</h2>
          <p className="text-slate-400 text-sm">
            Curated shows across the day.
          </p>
        </div>
        <div className="space-y-4">
          {SCHEDULE_DATA.map((show, i) => (
            <div
              key={show.id}
              className="glass-card rounded-2xl p-4 flex items-center gap-4 hover:bg-slate-800/50 transition-colors animate-slide-up"
              style={{ animationDelay: `${i * 80}ms` }}
            >
              <div className="w-16 h-16 rounded-xl bg-slate-900 flex flex-col items-center justify-center border border-white/10 text-slate-100">
                <span className="text-[10px] uppercase tracking-wide text-slate-400">
                  {show.time.split(" ")[1]}
                </span>
                <span className="text-lg font-black">
                  {show.time.split(" ")[0]}
                </span>
              </div>
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <h3 className="font-semibold text-white truncate">
                    {show.title}
                  </h3>
                </div>
                <p className="text-xs text-slate-400 mt-1 flex items-center gap-2">
                  <UserCircle size={12} />
                  {show.host}
                  <span className="w-1 h-1 rounded-full bg-slate-500"></span>
                  <span>{show.type}</span>
                </p>
              </div>
              <button
                onClick={() => showToast(`Reminder set for ${show.title}`)}
                className="p-2 rounded-full bg-slate-900 text-slate-300 hover:text-emerald-400 hover:bg-slate-800 transition"
              >
                <BellRing size={18} />
              </button>
            </div>
          ))}
        </div>
      </div>
    );

    // Search
    const SearchView = ({ posts, onPlay }) => {
      const [query, setQuery] = useState("");
      const filtered = posts.filter((p) => {
        const q = query.toLowerCase();
        return (
          p.title?.toLowerCase().includes(q) ||
          p.authorName?.toLowerCase().includes(q) ||
          p.category?.toLowerCase().includes(q)
        );
      });

      return (
        <div className="p-5 pb-24 animate-fade-in min-h-screen" key="search">
          <div className="sticky top-0 bg-[#020617]/90 backdrop-blur-md -mx-5 px-5 py-2 z-30">
            <div className="relative">
              <Search
                size={18}
                className="absolute left-3 top-3 text-slate-500"
              />
              <input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Search shows, hosts, categories..."
                className="w-full bg-slate-900 border border-slate-800 rounded-xl pl-9 pr-3 py-2.5 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
              />
            </div>
          </div>

          <div className="mt-4 space-y-3">
            {query && filtered.length === 0 && (
              <div className="text-center text-slate-500 py-12">
                <Ghost size={40} className="mx-auto mb-3 opacity-50" />
                No broadcasts matching your search.
              </div>
            )}

            {filtered.map((post, i) => (
              <div
                key={post.id}
                className="glass-card rounded-xl p-3 flex gap-3 items-center animate-slide-up"
                style={{ animationDelay: `${i * 40}ms` }}
              >
                <div
                  onClick={() =>
                    post.mediaUrl &&
                    onPlay({
                      title: post.title,
                      artist: post.authorName,
                      url: post.mediaUrl
                    })
                  }
                  className="w-16 h-16 rounded-lg bg-slate-900 border border-white/10 overflow-hidden relative flex items-center justify-center cursor-pointer"
                >
                  {post.thumbnailUrl ? (
                    <img
                      src={post.thumbnailUrl}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <Radio size={22} className="text-slate-400" />
                  )}
                  {post.mediaUrl && (
                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 hover:opacity-100 transition">
                      <Play
                        size={18}
                        className="text-white fill-white translate-x-[1px]"
                      />
                    </div>
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <h4 className="text-sm font-semibold text-white truncate">
                    {post.title}
                  </h4>
                  <p className="text-xs text-slate-400 truncate">
                    {post.isAnonymous ? "Anonymous" : post.authorName}
                  </p>
                  <div className="flex items-center gap-2 mt-1">
                    {post.category && (
                      <span className="text-[10px] px-2 py-0.5 rounded-full bg-slate-900 text-slate-300 border border-slate-700">
                        {post.category}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Post card
    const PostCard = ({
      post,
      onPlay,
      onLike,
      isLiked,
      user,
      onComment,
      onDelete,
      onReport
    }) => {
      const [animLike, setAnimLike] = useState(false);
      const [showOptions, setShowOptions] = useState(false);
      const isAuthor = user.uid === post.authorId;
      const isVideo = post.mediaType === "video";
      const isLive = post.broadcastType === "live" && post.isLive !== false;

      const handleLike = (e) => {
        e.stopPropagation();
        if (isLiked) return;
        setAnimLike(true);
        onLike(post.id);
        setTimeout(() => setAnimLike(false), 250);
      };

      const handleShare = async (e) => {
        e.stopPropagation();
        const shareData = {
          title: `BMU Radio: ${post.title}`,
          text: `Listen to "${post.title}" on BMU Campus Radio`,
          url: window.location.href
        };
        try {
          if (navigator.share) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(
              `${shareData.text} - ${shareData.url}`
            );
            alert("Link copied to clipboard");
          }
        } catch (err) {
          console.error(err);
        }
      };

      return (
        <div className="glass-card rounded-2xl overflow-hidden hover:border-slate-500/60 transition-all">
          <div className="p-4">
            <div className="flex items-start justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full overflow-hidden bg-gradient-to-tr from-indigo-500 to-emerald-500 flex items-center justify-center text-xs font-bold border border-white/10">
                  {post.authorPhoto && !post.isAnonymous ? (
                    <img
                      src={post.authorPhoto}
                      className="w-full h-full object-cover"
                    />
                  ) : post.isAnonymous ? (
                    <Ghost size={18} className="text-white" />
                  ) : (
                    <span>
                      {post.authorName ? post.authorName.charAt(0) : "B"}
                    </span>
                  )}
                </div>
                <div>
                  <div className="flex items-center gap-1.5">
                    <span className="text-sm font-semibold text-white">
                      {post.isAnonymous
                        ? "Anonymous"
                        : post.authorName?.split("_")[0]}
                    </span>
                    {post.likes > 5 && !post.isAnonymous && (
                      <CheckCircle
                        size={11}
                        className="text-emerald-400 fill-emerald-400"
                      />
                    )}
                  </div>
                  <p className="text-[11px] text-slate-400 flex items-center gap-2">
                    <span>
                      {post.createdAt
                        ? new Date(
                            post.createdAt.seconds * 1000
                          ).toLocaleString([], {
                            day: "2-digit",
                            month: "short"
                          })
                        : "Just now"}
                    </span>
                    <span className="w-1 h-1 rounded-full bg-slate-500"></span>
                    <span>{post.category || "General"} </span>
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                {isLive && (
                  <span className="px-2 py-0.5 rounded-full bg-red-600 text-[10px] font-bold tracking-wide text-white flex items-center gap-1 animate-pulse">
                    <span className="w-1.5 h-1.5 rounded-full bg-white"></span>
                    LIVE
                  </span>
                )}
                <div className="relative">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowOptions((v) => !v);
                    }}
                    className="p-1 rounded-full hover:bg-white/10 text-slate-400"
                  >
                    <MoreVertical size={18} />
                  </button>
                  {showOptions && (
                    <>
                      <div
                        className="fixed inset-0 z-20"
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowOptions(false);
                        }}
                      />
                      <div className="absolute right-0 top-7 w-40 bg-slate-900 border border-slate-700 rounded-xl shadow-xl z-30 text-sm overflow-hidden">
                        {isAuthor && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              onDelete(post.id);
                              setShowOptions(false);
                            }}
                            className="w-full text-left px-4 py-2.5 text-red-400 hover:bg-white/5 flex items-center gap-2"
                          >
                            <Trash2 size={14} /> Delete
                          </button>
                        )}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onReport(post.id);
                            setShowOptions(false);
                          }}
                          className="w-full text-left px-4 py-2.5 text-slate-200 hover:bg-white/5"
                        >
                          Report
                        </button>
                        <button
                          onClick={(e) => {
                            handleShare(e);
                            setShowOptions(false);
                          }}
                          className="w-full text-left px-4 py-2.5 text-slate-200 hover:bg-white/5 flex items-center gap-2"
                        >
                          <Share2 size={14} /> Share
                        </button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>

            <h3 className="text-base font-semibold text-white mb-1">
              {post.title}
            </h3>
            {post.description && (
              <p className="text-sm text-slate-300 mb-3 line-clamp-3">
                {post.description}
              </p>
            )}

            {post.mediaUrl && (
              <>
                {isVideo ? (
                  <div className="rounded-2xl overflow-hidden border border-white/10 bg-black mb-3">
                    <video
                      src={post.mediaUrl}
                      controls
                      className="w-full h-full"
                    />
                  </div>
                ) : (
                  <div
                    className="mb-3 rounded-2xl overflow-hidden border border-white/10 relative bg-slate-950 cursor-pointer"
                    onClick={() =>
                      onPlay({
                        title: post.title,
                        artist: post.authorName,
                        url: post.mediaUrl
                      })
                    }
                  >
                    {post.thumbnailUrl && (
                      <img
                        src={post.thumbnailUrl}
                        className="absolute inset-0 w-full h-full object-cover opacity-70"
                      />
                    )}
                    {!post.thumbnailUrl && (
                      <div className="absolute inset-0 bg-gradient-to-r from-indigo-600/40 to-emerald-500/40" />
                    )}
                    <div className="relative z-10 flex items-center justify-between px-4 py-3">
                      <div>
                        <p className="text-xs text-slate-200 font-semibold">
                          Tap to play
                        </p>
                        <p className="text-[11px] text-slate-400">
                          Audio broadcast
                        </p>
                      </div>
                      <button className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-lg">
                        <Play
                          size={18}
                          className="text-slate-900 fill-slate-900 translate-x-[1px]"
                        />
                      </button>
                    </div>
                  </div>
                )}
              </>
            )}
          </div>

          <div className="px-4 py-2.5 border-t border-white/5 bg-slate-950/60 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button
                onClick={handleLike}
                className={`flex items-center gap-1.5 text-xs font-medium ${
                  isLiked
                    ? "text-rose-400"
                    : "text-slate-400 hover:text-slate-100"
                } ${animLike ? "animate-pop" : ""}`}
              >
                <Heart
                  size={16}
                  className={isLiked ? "fill-current" : ""}
                />{" "}
                {post.likes || 0}
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onComment(post);
                }}
                className="flex items-center gap-1.5 text-xs text-slate-400 hover:text-slate-100"
              >
                <MessageCircle size={16} /> Comment
              </button>
            </div>
            <button
              onClick={handleShare}
              className="text-slate-400 hover:text-slate-100"
            >
              <Share2 size={15} />
            </button>
          </div>
        </div>
      );
    };

    // Mini Player
    const MiniPlayer = ({ currentTrack, isPlaying, togglePlay, close }) => {
      const hasTrack = currentTrack && currentTrack.url;
      if (!hasTrack) return null;
      return (
        <div className="fixed bottom-[70px] left-3 right-3 z-[60] animate-slide-up">
          <div className="bg-slate-900/90 border border-slate-700 rounded-2xl px-3 py-2.5 flex items-center gap-3 shadow-2xl backdrop-blur-xl">
            <div className="w-9 h-9 rounded-xl bg-indigo-600 flex items-center justify-center overflow-hidden">
              {isPlaying ? (
                <div className="flex items-end gap-[2px] h-3">
                  <div className="w-1 bg-white rounded-full equalizer-bar"></div>
                  <div className="w-1 bg-white rounded-full equalizer-bar"></div>
                  <div className="w-1 bg-white rounded-full equalizer-bar"></div>
                </div>
              ) : (
                <Music size={16} className="text-white" />
              )}
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-xs text-slate-100 truncate">
                {currentTrack.title}
              </p>
              <p className="text-[10px] text-slate-400 truncate">
                {currentTrack.artist}
              </p>
            </div>
            <button
              onClick={togglePlay}
              className="p-1.5 rounded-full bg-slate-100 text-slate-900 hover:bg-white"
            >
              {isPlaying ? (
                <Pause size={18} className="fill-slate-900" />
              ) : (
                <Play
                  size={18}
                  className="fill-slate-900 translate-x-[1px]"
                />
              )}
            </button>
            <button
              onClick={close}
              className="text-slate-400 hover:text-slate-100"
            >
              <X size={16} />
            </button>
          </div>
        </div>
      );
    };

    // Comments sheet
    const CommentSheet = ({ post, user, onClose }) => {
      const [comments, setComments] = useState([]);
      const [text, setText] = useState("");
      const [loading, setLoading] = useState(false);
      const endRef = useRef(null);

      useEffect(() => {
        if (!post) return;

        if (user.uid === "guest") {
          setComments([
            {
              id: "c1",
              text: "Nice broadcast!",
              authorName: "Guest_User",
              createdAt: { seconds: Date.now() / 1000 }
            }
          ]);
          return;
        }

        const qRef = query(
          collection(db, "bmu_radio_comments"),
          where("postId", "==", post.id)
        );
        const unsub = onSnapshot(qRef, (snap) => {
          const list = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          list.sort(
            (a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)
          );
          setComments(list);
          setTimeout(
            () => endRef.current?.scrollIntoView({ behavior: "smooth" }),
            80
          );
        });
        return () => unsub();
      }, [post, user]);

      const send = async (e) => {
        e.preventDefault();
        if (!text.trim()) return;

        if (user.uid === "guest") {
          setComments((prev) => [
            ...prev,
            {
              id: Date.now().toString(),
              text,
              authorName: "Guest_User",
              createdAt: { seconds: Date.now() / 1000 }
            }
          ]);
          setText("");
          return;
        }

        setLoading(true);
        try {
          await addDoc(collection(db, "bmu_radio_comments"), {
            postId: post.id,
            text,
            authorId: user.uid,
            authorName: user.displayName,
            authorPhoto: user.photoURL,
            createdAt: serverTimestamp()
          });
          setText("");
        } catch (err) {
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 z-[80] flex items-end sm:items-center justify-center">
          <div
            className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            onClick={onClose}
          />
          <div className="bg-slate-950 w-full max-w-lg h-[80vh] rounded-t-3xl sm:rounded-3xl border border-slate-700 shadow-2xl relative z-10 flex flex-col animate-slide-up">
            <div className="flex items-center justify-between px-4 py-3 border-b border-slate-800">
              <div>
                <p className="text-sm font-semibold text-white">Comments</p>
                <p className="text-[11px] text-slate-400 line-clamp-1">
                  {post?.title}
                </p>
              </div>
              <button
                onClick={onClose}
                className="p-1.5 rounded-full hover:bg-white/10 text-slate-400"
              >
                <X size={18} />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {comments.length === 0 && (
                <div className="text-center text-slate-500 py-10">
                  <MessageCircle
                    size={30}
                    className="mx-auto mb-2 opacity-50"
                  />
                  Be the first to comment on this broadcast.
                </div>
              )}
              {comments.map((c) => (
                <div key={c.id} className="flex gap-2">
                  <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[11px] border border-slate-700 overflow-hidden">
                    {c.authorPhoto ? (
                      <img
                        src={c.authorPhoto}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <User size={14} className="text-slate-300" />
                    )}
                  </div>
                  <div className="flex-1">
                    <div className="bg-slate-900/80 rounded-2xl rounded-tl-none px-3 py-2 border border-slate-700">
                      <p className="text-[11px] font-semibold text-slate-200">
                        {c.authorName?.split("_")[0]}
                      </p>
                      <p className="text-sm text-slate-50">{c.text}</p>
                    </div>
                    <p className="text-[10px] text-slate-500 ml-2 mt-0.5">
                      {c.createdAt
                        ? new Date(
                            c.createdAt.seconds * 1000
                          ).toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit"
                          })
                        : "Just now"}
                    </p>
                  </div>
                </div>
              ))}
              <div ref={endRef} />
            </div>

            <form
              onSubmit={send}
              className="px-3 pb-3 pt-2 border-t border-slate-800 bg-slate-950/95"
            >
              <div className="flex items-center gap-2">
                <input
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  placeholder="Add a comment..."
                  className="flex-1 bg-slate-900 border border-slate-700 rounded-full px-3 py-2 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
                />
                <button
                  type="submit"
                  disabled={!text.trim() || loading}
                  className="w-9 h-9 rounded-full bg-emerald-500 text-white flex items-center justify-center text-sm disabled:opacity-60"
                >
                  <Send size={16} />
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Bottom nav
    const NavigationBar = ({ activeView, onViewChange, onCreateClick }) => {
      const items = [
        { id: "feed", label: "Home", icon: Home },
        { id: "search", label: "Search", icon: Search },
        { id: "create", label: "Broadcast", icon: Plus, isAction: true },
        { id: "schedule", label: "Schedule", icon: Calendar },
        { id: "profile", label: "Profile", icon: User }
      ];
      return (
        <div className="fixed bottom-0 left-0 right-0 z-40 glass-panel border-t border-white/10">
          <div className="max-w-xl mx-auto h-16 flex items-center justify-around px-2">
            {items.map((item) =>
              item.isAction ? (
                <button
                  key={item.id}
                  onClick={onCreateClick}
                  className="relative -top-4 w-14 h-14 rounded-2xl bg-white text-slate-900 flex items-center justify-center shadow-xl shadow-slate-900/40 hover:scale-105 active:scale-95 transition"
                >
                  <Plus size={26} />
                </button>
              ) : (
                <button
                  key={item.id}
                  onClick={() => onViewChange(item.id)}
                  className={`flex flex-col items-center gap-0.5 text-[11px] ${
                    activeView === item.id
                      ? "text-white"
                      : "text-slate-400 hover:text-slate-100"
                  }`}
                >
                  <item.icon
                    size={20}
                    strokeWidth={activeView === item.id ? 2.5 : 2}
                  />
                  <span>{item.label}</span>
                </button>
              )
            )}
          </div>
        </div>
      );
    };

    // Broadcast type chooser (light)
    const BroadcastModeChooser = ({
      onSelectRecorded,
      onSelectLive,
      onClose
    }) => {
      return (
        <div className="fixed inset-0 z-[120] flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            onClick={onClose}
          />
          <div className="relative bg-white w-full max-w-lg rounded-3xl shadow-2xl border border-slate-200 px-6 py-5 animate-slide-up">
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                  New Broadcast
                </p>
                <h2 className="text-lg font-black text-slate-900">
                  Choose studio mode
                </h2>
              </div>
              <button
                onClick={onClose}
                className="text-slate-400 hover:text-slate-900"
              >
                <X size={18} />
              </button>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
              <button
                onClick={onSelectLive}
                className="group rounded-2xl border border-slate-200 px-4 py-4 text-left bg-slate-50 hover:bg-slate-900 hover:border-slate-900 hover:text-white transition-all flex flex-col justify-between"
              >
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-9 h-9 rounded-full bg-red-500 text-white flex items-center justify-center shadow-md">
                    <Mic size={18} />
                  </div>
                  <div>
                    <p className="text-sm font-semibold">Go Live Studio</p>
                    <p className="text-[11px] text-slate-500 group-hover:text-slate-300">
                      Real-time audio / video with BMU.
                    </p>
                  </div>
                </div>
                <ul className="text-[11px] text-slate-500 group-hover:text-slate-300 list-disc list-inside space-y-0.5">
                  <li>Audio or video live</li>
                  <li>Live status in feed</li>
                </ul>
              </button>

              <button
                onClick={onSelectRecorded}
                className="group rounded-2xl border border-slate-200 px-4 py-4 text-left bg-slate-50 hover:bg-slate-900 hover:border-slate-900 hover:text-white transition-all flex flex-col justify-between"
              >
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-9 h-9 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md">
                    <Upload size={18} />
                  </div>
                  <div>
                    <p className="text-sm font-semibold">
                      Recorded Broadcast Studio
                    </p>
                    <p className="text-[11px] text-slate-500 group-hover:text-slate-300">
                      Upload podcasts, mixes, sessions.
                    </p>
                  </div>
                </div>
                <ul className="text-[11px] text-slate-500 group-hover:text-slate-300 list-disc list-inside space-y-0.5">
                  <li>Audio or video upload</li>
                  <li>Custom thumbnail & category</li>
                </ul>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Recorded broadcast modal
    const RecordedBroadcastModal = ({ user, onClose }) => {
      const [title, setTitle] = useState("");
      const [description, setDescription] = useState("");
      const [category, setCategory] = useState("music");
      const [mediaFile, setMediaFile] = useState(null);
      const [thumbFile, setThumbFile] = useState(null);
      const [mediaPreview, setMediaPreview] = useState(null);
      const [thumbPreview, setThumbPreview] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [progress, setProgress] = useState(0);

      const handleMediaChange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        setMediaFile(f);
        setMediaPreview(URL.createObjectURL(f));
      };

      const handleThumbChange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        setThumbFile(f);
        setThumbPreview(URL.createObjectURL(f));
      };

      const publish = async () => {
        if (!title.trim() || !mediaFile) {
          alert("Title and media are required.");
          return;
        }
        setUploading(true);
        try {
          const mediaType = mediaFile.type.startsWith("video")
            ? "video"
            : "audio";
          const mediaRef = ref(
            storage,
            `broadcasts/${user.uid}/${Date.now()}_${mediaFile.name}`
          );
          const task = uploadBytesResumable(mediaRef, mediaFile);

          await new Promise((resolve, reject) => {
            task.on(
              "state_changed",
              (snap) => {
                const pct =
                  (snap.bytesTransferred / snap.totalBytes) * 100 || 0;
                setProgress(pct);
              },
              reject,
              resolve
            );
          });

          const mediaUrl = await getDownloadURL(task.snapshot.ref);

          let thumbUrl = null;
          if (thumbFile) {
            const thumbRef = ref(
              storage,
              `thumbnails/${user.uid}/${Date.now()}_${thumbFile.name}`
            );
            const ttask = uploadBytesResumable(thumbRef, thumbFile);
            await new Promise((resolve, reject) => {
              ttask.on("state_changed", null, reject, resolve);
            });
            thumbUrl = await getDownloadURL(ttask.snapshot.ref);
          }

          await addDoc(collection(db, "bmu_radio_posts"), {
            title,
            description,
            category,
            mediaUrl,
            mediaType,
            thumbnailUrl: thumbUrl,
            authorId: user.uid,
            authorName: user.displayName,
            authorPhoto: user.photoURL,
            likes: 0,
            broadcastType: "recorded",
            createdAt: serverTimestamp()
          });

          onClose();
        } catch (err) {
          console.error(err);
          alert("Upload failed. Check console.");
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="fixed inset-0 z-[140] flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            onClick={onClose}
          />
          <div className="relative bg-white w-full max-w-2xl rounded-3xl shadow-2xl border border-slate-200 p-6 max-h-[92vh] overflow-y-auto animate-slide-up">
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="text-xs text-slate-500 font-semibold uppercase tracking-wide">
                  Recorded Studio
                </p>
                <h2 className="text-lg font-black text-slate-900">
                  Upload broadcast
                </h2>
              </div>
              <button
                onClick={onClose}
                className="text-slate-400 hover:text-slate-900"
              >
                <X size={18} />
              </button>
            </div>

            <div className="grid md:grid-cols-[1.6fr_1fr] gap-4">
              <div>
                <label className="block text-xs font-semibold text-slate-600 mb-1">
                  Title
                </label>
                <input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Give your show a title"
                  className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900"
                />

                <label className="block text-xs font-semibold text-slate-600 mt-3 mb-1">
                  Description
                </label>
                <textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  rows={3}
                  placeholder="Describe what listeners will hear"
                  className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-slate-900"
                />

                <div className="flex flex-col md:flex-row gap-3 mt-3">
                  <div className="flex-1">
                    <label className="block text-xs font-semibold text-slate-600 mb-1">
                      Category
                    </label>
                    <select
                      value={category}
                      onChange={(e) => setCategory(e.target.value)}
                      className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-slate-900"
                    >
                      <option value="music">Music</option>
                      <option value="podcast">Podcast</option>
                      <option value="buzz">Campus Buzz</option>
                      <option value="skills">Talk / Skill</option>
                    </select>
                  </div>
                </div>

                <div className="mt-4">
                  <label className="block text-xs font-semibold text-slate-600 mb-1">
                    Audio / Video file
                  </label>
                  <label className="w-full border-2 border-dashed border-slate-200 rounded-xl px-4 py-4 text-sm flex items-center justify-between hover:border-slate-900 hover:bg-slate-50 cursor-pointer transition">
                    <div>
                      <p className="font-semibold text-slate-900">
                        {mediaFile ? mediaFile.name : "Choose audio or video"}
                      </p>
                      <p className="text-[11px] text-slate-500">
                        Supported: mp3, wav, mp4, webm
                      </p>
                    </div>
                    <input
                      type="file"
                      accept="audio/*,video/*"
                      className="hidden"
                      onChange={handleMediaChange}
                    />
                    <div className="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center">
                      <Upload size={16} />
                    </div>
                  </label>
                </div>

                {mediaPreview && (
                  <div className="mt-3 rounded-xl border border-slate-200 overflow-hidden bg-slate-100">
                    {mediaFile?.type.startsWith("video") ? (
                      <video src={mediaPreview} controls className="w-full" />
                    ) : (
                      <audio src={mediaPreview} controls className="w-full" />
                    )}
                  </div>
                )}
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-semibold text-slate-600 mb-1">
                    Thumbnail (optional)
                  </label>
                  <label className="w-full border-2 border-dashed border-slate-200 rounded-xl aspect-video flex items-center justify-center text-[11px] text-slate-500 hover:border-slate-900 hover:bg-slate-50 cursor-pointer transition overflow-hidden bg-slate-50">
                    {thumbPreview ? (
                      <img
                        src={thumbPreview}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <span>Upload cover image</span>
                    )}
                    <input
                      type="file"
                      accept="image/*"
                      className="hidden"
                      onChange={handleThumbChange}
                    />
                  </label>
                </div>

                {uploading && (
                  <div className="mt-2">
                    <p className="text-[11px] text-slate-500 mb-1">
                      Uploading... {progress.toFixed(0)}%
                    </p>
                    <div className="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
                      <div
                        style={{ width: `${progress}%` }}
                        className="h-full bg-slate-900 transition-all"
                      />
                    </div>
                  </div>
                )}

                <button
                  disabled={uploading}
                  onClick={publish}
                  className="w-full mt-4 bg-slate-900 text-white rounded-xl py-2.5 text-sm font-semibold hover:bg-black disabled:opacity-60"
                >
                  {uploading ? "Publishing..." : "Publish broadcast"}
                </button>
                <button
                  onClick={onClose}
                  className="w-full text-sm text-slate-500 hover:text-slate-900 py-2"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Go Live modal
    const LiveBroadcastModal = ({ user, onClose }) => {
      const [liveTitle, setLiveTitle] = useState("");
      const [liveDesc, setLiveDesc] = useState("");
      const [mode, setMode] = useState("audio"); // audio | video
      const [recording, setRecording] = useState(false);
      const [progress, setProgress] = useState(0);
      const [livePostId, setLivePostId] = useState(null);
      const mediaRecorderRef = useRef(null);
      const streamRef = useRef(null);
      const videoRef = useRef(null);

      const startLive = async () => {
        if (!liveTitle.trim()) {
          alert("Add a title for your live session.");
          return;
        }
        try {
          const constraints =
            mode === "video"
              ? { audio: true, video: { facingMode: "user" } }
              : { audio: true };
          const stream = await navigator.mediaDevices.getUserMedia(
            constraints
          );
          streamRef.current = stream;
          if (mode === "video" && videoRef.current) {
            videoRef.current.srcObject = stream;
          }

          // create live post in feed
          const postRef = await addDoc(collection(db, "bmu_radio_posts"), {
            title: liveTitle,
            description: liveDesc,
            category: "live",
            mediaUrl: "",
            mediaType: mode,
            thumbnailUrl: null,
            authorId: user.uid,
            authorName: user.displayName,
            authorPhoto: user.photoURL,
            likes: 0,
            broadcastType: "live",
            isLive: true,
            createdAt: serverTimestamp()
          });
          setLivePostId(postRef.id);

          const options =
            mode === "video"
              ? { mimeType: "video/webm" }
              : { mimeType: "audio/webm" };
          const recorder = new MediaRecorder(stream, options);
          mediaRecorderRef.current = recorder;

          recorder.ondataavailable = async (e) => {
            const chunk = e.data;
            if (!chunk.size) return;
            const fileRef = ref(
              storage,
              `live_chunks/${user.uid}/${postRef.id}/${Date.now()}.webm`
            );
            const uploadTask = uploadBytesResumable(fileRef, chunk);
            uploadTask.on("state_changed", (snap) => {
              const pct =
                (snap.bytesTransferred / snap.totalBytes) * 100 || 0;
              setProgress(pct);
            });
          };

          recorder.start(3000); // chunk every 3s
          setRecording(true);
        } catch (err) {
          console.error(err);
          alert("Microphone / camera permission denied.");
        }
      };

      const stopLive = async () => {
        mediaRecorderRef.current?.stop();
        streamRef.current?.getTracks().forEach((t) => t.stop());
        setRecording(false);
        if (livePostId) {
          await updateDoc(doc(db, "bmu_radio_posts", livePostId), {
            isLive: false,
            endedAt: serverTimestamp()
          });
        }
        onClose();
      };

      return (
        <div className="fixed inset-0 z-[150] flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/60 backdrop-blur-sm"
            onClick={!recording ? onClose : undefined}
          />
          <div className="relative bg-white w-full max-w-3xl rounded-3xl border border-slate-200 shadow-2xl p-6 max-h-[92vh] overflow-y-auto animate-slide-up">
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="text-xs font-semibold uppercase text-red-500 tracking-wide">
                  Live Studio
                </p>
                <h2 className="text-lg font-black text-slate-900">
                  {recording ? "You are live" : "Set up your live broadcast"}
                </h2>
              </div>
              <button
                onClick={!recording ? onClose : stopLive}
                className={`rounded-full px-3 py-1.5 text-xs font-semibold ${
                  recording
                    ? "bg-red-600 text-white"
                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                }`}
              >
                {recording ? "End live" : "Close"}
              </button>
            </div>

            <div className="grid md:grid-cols-[1.5fr_1fr] gap-4">
              <div>
                <div className="flex gap-2 mb-3">
                  <button
                    type="button"
                    disabled={recording}
                    onClick={() => setMode("audio")}
                    className={`flex-1 flex items-center justify-center gap-1.5 rounded-xl border px-3 py-2 text-xs font-semibold ${
                      mode === "audio"
                        ? "border-red-500 bg-red-50 text-red-700"
                        : "border-slate-200 text-slate-600 hover:border-slate-400"
                    }`}
                  >
                    <Mic size={14} />
                    Audio Live
                  </button>
                  <button
                    type="button"
                    disabled={recording}
                    onClick={() => setMode("video")}
                    className={`flex-1 flex items-center justify-center gap-1.5 rounded-xl border px-3 py-2 text-xs font-semibold ${
                      mode === "video"
                        ? "border-red-500 bg-red-50 text-red-700"
                        : "border-slate-200 text-slate-600 hover:border-slate-400"
                    }`}
                  >
                    <Video size={14} />
                    Video Live
                  </button>
                </div>

                {mode === "video" ? (
                  <div className="rounded-2xl overflow-hidden border border-slate-200 bg-black aspect-video flex items-center justify-center relative">
                    <video
                      ref={videoRef}
                      autoPlay
                      muted
                      className="w-full h-full object-cover"
                    />
                    {!recording && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black/60 text-white text-xs">
                        Preview activates when you start live.
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="rounded-2xl border border-slate-200 bg-slate-50 p-4 flex flex-col items-center justify-center">
                    <div className="w-14 h-14 rounded-full bg-red-500 text-white flex items-center justify-center mb-3 shadow-md">
                      <Mic size={26} />
                    </div>
                    <p className="text-xs text-slate-600 text-center max-w-xs">
                      Your microphone will stream audio live to listeners. Keep
                      this page open while broadcasting.
                    </p>
                    {recording && (
                      <div className="mt-4 flex items-center gap-2 text-xs text-red-600 font-semibold">
                        <span className="w-2 h-2 rounded-full bg-red-600 animate-ping" />
                        Live streaming in progress...
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="space-y-3">
                <div>
                  <label className="block text-xs font-semibold text-slate-600 mb-1">
                    Live title
                  </label>
                  <input
                    value={liveTitle}
                    onChange={(e) => setLiveTitle(e.target.value)}
                    placeholder="E.g. Campus Evening Jam"
                    className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500"
                    disabled={recording}
                  />
                </div>
                <div>
                  <label className="block text-xs font-semibold text-slate-600 mb-1">
                    Description
                  </label>
                  <textarea
                    value={liveDesc}
                    onChange={(e) => setLiveDesc(e.target.value)}
                    rows={3}
                    placeholder="Tell listeners what this live session is about."
                    className="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-red-500"
                    disabled={recording}
                  />
                </div>

                {recording && (
                  <div className="mt-2">
                    <p className="text-[11px] text-slate-500 mb-1">
                      Uploading live chunks... {progress.toFixed(0)}%
                    </p>
                    <div className="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
                      <div
                        style={{ width: `${progress}%` }}
                        className="h-full bg-red-500 transition-all"
                      />
                    </div>
                  </div>
                )}

                {!recording ? (
                  <button
                    onClick={startLive}
                    className="w-full mt-3 bg-red-600 text-white rounded-xl py-2.5 text-sm font-semibold hover:bg-red-700"
                  >
                    Go live now
                  </button>
                ) : (
                  <button
                    onClick={stopLive}
                    className="w-full mt-3 bg-slate-900 text-white rounded-xl py-2.5 text-sm font-semibold hover:bg-black"
                  >
                    End live & close
                  </button>
                )}

                <p className="text-[10px] text-slate-400 mt-2">
                  Note: This implementation simulates live by uploading audio /
                  video chunks every few seconds to the server. Listeners see
                  your session as LIVE in the feed.
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Footer
    const Footer = () => (
      <div className="mt-12 mb-20 px-6 text-center">
        <div className="glass-card rounded-2xl p-5 border border-white/10">
          <p className="text-xs text-slate-300">
            Built for the{" "}
            <span className="font-semibold text-emerald-300">BMU</span> student
            community.
          </p>
          <p className="text-[10px] text-slate-500 mt-1">
            Contact:{" "}
            <a
              href="mailto:vivek.yadav25cse@bmu.edu.in"
              className="underline underline-offset-2"
            >
              vivek.yadav25cse@bmu.edu.in
            </a>
          </p>
        </div>
      </div>
    );

    // MAIN APP
    function App() {
      const [user, setUser] = useState(null);
      const [activeView, setActiveView] = useState("feed");
      const [posts, setPosts] = useState([]);
      const [currentTrack, setCurrentTrack] = useState(null);
      const [isPlaying, setIsPlaying] = useState(false);
      const [commentPost, setCommentPost] = useState(null);
      const [loading, setLoading] = useState(true);
      const [likedIds, setLikedIds] = useState(new Set());
      const [toast, setToast] = useState(null);

      const [showModeChooser, setShowModeChooser] = useState(false);
      const [showRecordedModal, setShowRecordedModal] = useState(false);
      const [showLiveModal, setShowLiveModal] = useState(false);

      const audioRef = useRef(new Audio());

      const showToast = (msg) => {
        setToast(msg);
        setTimeout(() => setToast(null), 2800);
      };

      // Auth + posts
      useEffect(() => {
        const unsubAuth = onAuthStateChanged(auth, (u) => {
          // DEFAULT AUTO-LOGIN:
          // if Firebase finds existing session, u is not null and app skips login page
          setUser(u || null);
          setLoading(false);
        });

        const qPosts = query(
          collection(db, "bmu_radio_posts"),
          orderBy("createdAt", "desc")
        );
        const unsubPosts = onSnapshot(
          qPosts,
          (snap) => {
            setPosts(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
          },
          (err) => {
            console.error(err);
            setPosts(MOCK_POSTS);
          }
        );

        const storedLikes = localStorage.getItem("bmu_likes");
        if (storedLikes) {
          setLikedIds(new Set(JSON.parse(storedLikes)));
        }

        return () => {
          unsubAuth();
          unsubPosts();
        };
      }, []);

      useEffect(() => {
        const audio = audioRef.current;
        const onEnded = () => setIsPlaying(false);
        audio.addEventListener("ended", onEnded);
        return () => audio.removeEventListener("ended", onEnded);
      }, []);

      useEffect(() => {
        const audio = audioRef.current;
        if (currentTrack && currentTrack.url) {
          audio.src = currentTrack.url;
          audio.load();
          const p = audio.play();
          setIsPlaying(true);
          if (p && p.catch) {
            p.catch((e) => {
              console.error(e);
              setIsPlaying(false);
            });
          }
        } else {
          audio.pause();
          setIsPlaying(false);
        }
      }, [currentTrack]);

      const togglePlay = () => {
        const audio = audioRef.current;
        if (!currentTrack || !currentTrack.url) return;
        if (isPlaying) {
          audio.pause();
          setIsPlaying(false);
        } else {
          const p = audio.play();
          if (p && p.catch) {
            p.catch((e) => {
              console.error(e);
              setIsPlaying(false);
            });
          } else {
            setIsPlaying(true);
          }
        }
      };

      const likePost = async (id) => {
        if (likedIds.has(id)) return;
        const next = new Set(likedIds);
        next.add(id);
        setLikedIds(next);
        localStorage.setItem("bmu_likes", JSON.stringify([...next]));
        if (!user || user.uid === "guest") return;
        try {
          await updateDoc(doc(db, "bmu_radio_posts", id), {
            likes: increment(1)
          });
        } catch (err) {
          console.error(err);
        }
      };

      const deletePost = async (id) => {
        if (!user || user.uid === "guest") {
          showToast("Login with college ID to delete broadcasts.");
          return;
        }
        if (!confirm("Delete this broadcast permanently?")) return;
        try {
          await deleteDoc(doc(db, "bmu_radio_posts", id));
          showToast("Broadcast deleted.");
        } catch (err) {
          console.error(err);
        }
      };

      const reportPost = () => {
        showToast("Broadcast flagged for review.");
      };

      const handleLoginSuccess = (u, role) => {
        setUser(u);
        if (u.uid === "guest") setPosts(MOCK_POSTS);
        localStorage.setItem("bmu_user_role", role);
      };

      if (loading)
        return (
          <div className="h-screen flex items-center justify-center bg-[#020617] text-slate-200">
            <Background3D />
            <div className="flex items-center gap-2">
              <Radio className="animate-bounce" />
              <span className="text-sm">Tuning BMU Radio...</span>
            </div>
          </div>
        );

      // LOGIN SCREEN (when no user session)
      if (!user)
        return (
          <>
            <LoginSelection onLogin={handleLoginSuccess} error={null} />
          </>
        );

      const userPosts = posts.filter((p) => p.authorId === user.uid);

      return (
        <div className="min-h-screen pb-24 relative">
          <Background3D />
          {toast && <Toast message={toast} onClose={() => setToast(null)} />}

          <header className="sticky top-0 z-30 bg-[#020617]/90 backdrop-blur-xl border-b border-white/10 px-5 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-xl bg-white flex items-center justify-center text-slate-900 shadow-lg">
                <Radio size={18} />
              </div>
              <div>
                <p className="text-sm font-semibold text-white leading-none">
                  BMU FM
                </p>
                <p className="text-[10px] text-slate-400 leading-none mt-0.5">
                  Campus Radio Studio
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={async () => {
                  await signOut(auth);
                  window.location.reload();
                }}
                className="w-8 h-8 rounded-full bg-slate-900 text-slate-300 flex items-center justify-center hover:bg-slate-800 hover:text-white text-[10px]"
              >
                <LogOut size={14} />
              </button>
              <div className="w-8 h-8 rounded-full bg-slate-100 overflow-hidden flex items-center justify-center text-xs font-semibold text-slate-900 border border-slate-300">
                {user.photoURL ? (
                  <img
                    src={user.photoURL}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  user.displayName?.charAt(0)
                )}
              </div>
            </div>
          </header>

          {activeView === "feed" && (
            <main className="px-5 py-5 max-w-xl mx-auto">
              <div className="mb-6">
                <h2 className="text-2xl font-black text-white">
                  Today on BMU FM
                </h2>
                <p className="text-sm text-slate-400">
                  Fresh shows & live sessions from campus.
                </p>
              </div>

              <div className="glass-card rounded-2xl p-4 mb-6 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white shadow-md animate-pulse">
                    <Radio size={18} />
                  </div>
                  <div>
                    <p className="text-[11px] uppercase tracking-wide text-red-300 font-semibold">
                      Now Playing
                    </p>
                    <p className="text-sm text-white font-semibold">
                      Campus Evening Block
                    </p>
                  </div>
                </div>
                <button className="px-3 py-1.5 rounded-full bg-white text-xs font-semibold text-slate-900 shadow">
                  Listen
                </button>
              </div>

              {posts.length === 0 ? (
                <div className="text-center text-slate-500 py-12">
                  <p>No broadcasts yet. Be the first to go live!</p>
                </div>
              ) : (
                <div className="space-y-5">
                  {posts.map((p, i) => (
                    <div
                      key={p.id}
                      className="animate-slide-up"
                      style={{ animationDelay: `${120 + i * 80}ms` }}
                    >
                      <PostCard
                        post={p}
                        user={user}
                        onPlay={(t) => setCurrentTrack(t)}
                        onLike={likePost}
                        isLiked={likedIds.has(p.id)}
                        onComment={(post) => setCommentPost(post)}
                        onDelete={deletePost}
                        onReport={reportPost}
                      />
                    </div>
                  ))}
                </div>
              )}
            </main>
          )}

          {activeView === "search" && (
            <SearchView
              posts={posts}
              onPlay={(t) => setCurrentTrack(t)}
            />
          )}
          {activeView === "schedule" && <ScheduleView showToast={showToast} />}
          {activeView === "profile" && (
            <div className="p-6 pt-10 text-center max-w-xl mx-auto">
              <div className="w-24 h-24 rounded-full bg-slate-100 border border-slate-400 mx-auto flex items-center justify-center text-3xl font-bold text-slate-900 overflow-hidden mb-3">
                {user.photoURL ? (
                  <img
                    src={user.photoURL}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  user.displayName?.charAt(0)
                )}
              </div>
              <h2 className="text-xl font-black text-white">
                {user.displayName}
              </h2>
              <p className="text-xs text-slate-400 mt-1">
                {user.uid === "guest" ? "Guest listener" : "BMU Broadcaster"}
              </p>

              <div className="grid grid-cols-2 gap-4 mt-6">
                <div className="glass-card rounded-2xl p-4">
                  <p className="text-xs text-slate-400 uppercase font-semibold">
                    Broadcasts
                  </p>
                  <p className="text-2xl font-black text-white">
                    {userPosts.length}
                  </p>
                </div>
                <div className="glass-card rounded-2xl p-4">
                  <p className="text-xs text-slate-400 uppercase font-semibold">
                    Liked
                  </p>
                  <p className="text-2xl font-black text-white">
                    {likedIds.size}
                  </p>
                </div>
              </div>
            </div>
          )}

          <Footer />

          {commentPost && (
            <CommentSheet
              post={commentPost}
              user={user}
              onClose={() => setCommentPost(null)}
            />
          )}

          <MiniPlayer
            currentTrack={currentTrack}
            isPlaying={isPlaying}
            togglePlay={togglePlay}
            close={() => {
              audioRef.current.pause();
              setCurrentTrack(null);
            }}
          />

          <NavigationBar
            activeView={activeView}
            onViewChange={setActiveView}
            onCreateClick={() => {
              if (user.uid === "guest") {
                showToast(
                  "Login with your BMU ID to go live or upload broadcasts."
                );
              } else {
                setShowModeChooser(true);
              }
            }}
          />

          {showModeChooser && (
            <BroadcastModeChooser
              onSelectRecorded={() => {
                setShowModeChooser(false);
                setShowRecordedModal(true);
              }}
              onSelectLive={() => {
                setShowModeChooser(false);
                setShowLiveModal(true);
              }}
              onClose={() => setShowModeChooser(false)}
            />
          )}

          {showRecordedModal && (
            <RecordedBroadcastModal
              user={user}
              onClose={() => setShowRecordedModal(false)}
            />
          )}

          {showLiveModal && (
            <LiveBroadcastModal
              user={user}
              onClose={() => setShowLiveModal(false)}
            />
          )}
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
